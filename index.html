<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Will & LPA Generator</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Amiri:wght@400;700&family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="style.css">
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>&#9878;</text></svg>">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="config.js"></script>
    <script src="auth.js"></script>
</head>
<body>
    <!-- Header -->
    <header class="header">
        <div class="home-container">
            <div style="display:flex;justify-content:space-between;align-items:center;">
                <div class="logo">
                    <span class="logo-icon">&#9878;</span>
                    <div>
                        <h1 class="brand-name" style="font-size:1.25rem;margin:0;">Will & LPA Generator</h1>
                        <p style="font-size:0.8rem;opacity:0.8;margin:0;">Professional Legal Document Preparation</p>
                    </div>
                </div>
                <nav class="header-nav" id="mainNav" style="display:none;">
                    <a href="index.html" class="nav-link nav-link-active">Home</a>
                    <a href="islamic-will.html" class="nav-link" id="nav-islamic-will">Islamic Will</a>
                    <a href="lpa.html" class="nav-link" id="nav-islamic-lpa">Islamic LPA</a>
                    <a href="will-standard.html" class="nav-link" id="nav-standard-will">Standard Will</a>
                    <a href="lpa-standard.html" class="nav-link" id="nav-standard-lpa">Standard LPA</a>
                </nav>
                <div id="userHeaderArea"></div>
            </div>
        </div>
    </header>

    <!-- Auth Section (shown when NOT logged in) -->
    <div id="authSection" style="display:none;">
        <div class="home-container">
            <div class="auth-container">
                <div class="auth-logo">
                    <span style="font-size:3rem;">&#9878;</span>
                    <h2 class="brand-name">Will & LPA Generator</h2>
                    <p>Professional Legal Document Preparation</p>
                </div>

                <!-- Auth Tabs -->
                <div class="auth-tabs">
                    <button class="auth-tab active" onclick="switchAuthTab('login')">Login</button>
                    <button class="auth-tab" onclick="switchAuthTab('signup')">Sign Up</button>
                </div>

                <!-- Login Form -->
                <form id="loginForm" class="auth-form" onsubmit="handleLogin(event)">
                    <div class="auth-field">
                        <label>Email</label>
                        <input type="email" id="loginEmail" required placeholder="your@email.com">
                    </div>
                    <div class="auth-field">
                        <label>Password</label>
                        <input type="password" id="loginPassword" required placeholder="Enter your password" minlength="6">
                    </div>
                    <div id="loginError" class="auth-error" style="display:none;"></div>
                    <button type="submit" class="auth-btn" id="loginBtn">
                        <span>Login</span>
                    </button>
                </form>

                <!-- Signup Form -->
                <form id="signupForm" class="auth-form" style="display:none;" onsubmit="handleSignup(event)">
                    <div class="auth-field">
                        <label>Full Name</label>
                        <input type="text" id="signupName" required placeholder="John Smith">
                    </div>
                    <div class="auth-field">
                        <label>Email</label>
                        <input type="email" id="signupEmail" required placeholder="your@email.com">
                    </div>
                    <div class="auth-field">
                        <label>Password</label>
                        <input type="password" id="signupPassword" required placeholder="Min 6 characters" minlength="6">
                    </div>
                    <div class="auth-field">
                        <label>I am a...</label>
                        <select id="signupRole" required>
                            <option value="client">Client</option>
                            <option value="solicitor">Solicitor / Legal Professional</option>
                        </select>
                    </div>
                    <div id="signupError" class="auth-error" style="display:none;"></div>
                    <div id="signupSuccess" class="auth-success" style="display:none;"></div>
                    <button type="submit" class="auth-btn" id="signupBtn">
                        <span>Create Account</span>
                    </button>
                    <p class="auth-hint">By signing up you agree to our terms of service. A monthly subscription may be required for continued access.</p>
                </form>
            </div>
        </div>
    </div>

    <!-- Pending Approval Screen (shown when logged in but inactive) -->
    <div id="pendingSection" style="display:none;">
        <div class="home-container">
            <div style="max-width:480px;margin:4rem auto;text-align:center;background:white;border-radius:16px;padding:3rem 2rem;box-shadow:0 4px 24px rgba(0,0,0,0.08);border:1px solid #e5e7eb;">
                <svg width="56" height="56" viewBox="0 0 24 24" fill="none" stroke="#f59e0b" stroke-width="1.5" style="margin-bottom:1.25rem;">
                    <circle cx="12" cy="12" r="10"></circle>
                    <polyline points="12 6 12 12 16 14"></polyline>
                </svg>
                <h2 style="margin:0 0 0.75rem;color:#1e293b;font-size:1.5rem;">Awaiting Approval</h2>
                <p style="color:#64748b;margin:0 0 0.5rem;line-height:1.6;">Your account has been created successfully. An administrator will review your request and activate your account with the appropriate plan.</p>
                <p style="color:#94a3b8;font-size:0.85rem;margin:0 0 1.5rem;">You will be able to access the tools once your account is activated.</p>
                <button onclick="handleLogout()" style="background:#1e3a5f;color:white;border:none;padding:0.75rem 2rem;border-radius:8px;font-size:1rem;font-weight:500;cursor:pointer;font-family:inherit;">Sign Out</button>
            </div>
        </div>
    </div>

    <!-- App Section (shown when logged in) -->
    <div id="appSection" style="display:none;">
        <!-- Trial Banner -->
        <div id="trialBanner" style="display:none;">
            <div class="home-container">
                <div style="background:linear-gradient(135deg,#fef3c7,#fde68a);border:1px solid #f59e0b;border-radius:12px;padding:1rem 1.5rem;margin-top:1.5rem;display:flex;align-items:center;justify-content:space-between;gap:1rem;flex-wrap:wrap;">
                    <div style="display:flex;align-items:center;gap:0.75rem;">
                        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="#d97706" stroke-width="2"><circle cx="12" cy="12" r="10"></circle><polyline points="12 6 12 12 16 14"></polyline></svg>
                        <div>
                            <strong style="color:#92400e;" id="trialTitle">Free Trial</strong>
                            <p style="margin:0;color:#a16207;font-size:0.85rem;" id="trialMessage">You have X days remaining on your trial.</p>
                        </div>
                    </div>
                    <span style="background:#f59e0b;color:white;padding:0.35rem 1rem;border-radius:20px;font-size:0.8rem;font-weight:600;" id="trialBadge">Trial</span>
                </div>
            </div>
        </div>

        <!-- Hero Section -->
        <div class="home-container">
            <div class="home-hero">
                <h2 id="welcomeMessage">Welcome back</h2>
                <p>Create legally compliant Wills and Lasting Powers of Attorney with our step-by-step guided wizards. Choose the version that best suits your needs.</p>
            </div>

            <!-- Tool Cards Grid -->
            <div class="home-grid">
                <!-- Islamic Will -->
                <a href="islamic-will.html" class="home-card home-card-islamic" id="card-islamic-will">
                    <span class="home-card-badge">Islamic</span>
                    <div class="home-card-icon">
                        <svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14 2 14 8 20 8"></polyline><line x1="16" y1="13" x2="8" y2="13"></line><line x1="16" y1="17" x2="8" y2="17"></line></svg>
                    </div>
                    <h3>Islamic Will</h3>
                    <p>Shariah-compliant Will with Faraid inheritance distribution, Wasiyyah (bequests), religious obligations, and Mufti certification.</p>
                    <span class="home-card-arrow">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="5" y1="12" x2="19" y2="12"></line><polyline points="12 5 19 12 12 19"></polyline></svg>
                    </span>
                </a>

                <!-- Islamic LPA -->
                <a href="lpa.html" class="home-card home-card-islamic" id="card-islamic-lpa">
                    <span class="home-card-badge">Islamic</span>
                    <div class="home-card-icon">
                        <svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M9 12l2 2 4-4"></path><path d="M21 12a9 9 0 1 1-18 0 9 9 0 0 1 18 0z"></path></svg>
                    </div>
                    <h3>Islamic LPA</h3>
                    <p>Lasting Power of Attorney with Islamic guidance including halal finance, Shariah-compliant care preferences, and Islamic end-of-life wishes.</p>
                    <span class="home-card-arrow">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="5" y1="12" x2="19" y2="12"></line><polyline points="12 5 19 12 12 19"></polyline></svg>
                    </span>
                </a>

                <!-- Standard Will -->
                <a href="will-standard.html" class="home-card home-card-standard" id="card-standard-will">
                    <span class="home-card-badge">Standard</span>
                    <div class="home-card-icon">
                        <svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14 2 14 8 20 8"></polyline><line x1="16" y1="13" x2="8" y2="13"></line><line x1="16" y1="17" x2="8" y2="17"></line></svg>
                    </div>
                    <h3>Standard Will</h3>
                    <p>UK-compliant Will with full testamentary freedom. Distribute your estate to any beneficiaries with percentage-based allocation.</p>
                    <span class="home-card-arrow">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="5" y1="12" x2="19" y2="12"></line><polyline points="12 5 19 12 12 19"></polyline></svg>
                    </span>
                </a>

                <!-- Standard LPA -->
                <a href="lpa-standard.html" class="home-card home-card-standard" id="card-standard-lpa">
                    <span class="home-card-badge">Standard</span>
                    <div class="home-card-icon">
                        <svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M9 12l2 2 4-4"></path><path d="M21 12a9 9 0 1 1-18 0 9 9 0 0 1 18 0z"></path></svg>
                    </div>
                    <h3>Standard LPA</h3>
                    <p>Lasting Power of Attorney for Property & Financial Affairs or Health & Welfare. Includes official UK government form generation.</p>
                    <span class="home-card-arrow">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="5" y1="12" x2="19" y2="12"></line><polyline points="12 5 19 12 12 19"></polyline></svg>
                    </span>
                </a>
            </div>

            <!-- Solicitor: My Clients Section -->
            <div id="solicitorSection" style="display:none;">
                <div class="form-section" style="margin-bottom:2rem;">
                    <h3>My Clients</h3>
                    <p class="form-description">Manage your client list. Add clients you are preparing documents for.</p>
                    <div id="clientsList"></div>
                    <button class="btn-add" onclick="showAddClientForm()" style="margin-top:1rem;">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>
                        Add Client
                    </button>
                    <div id="addClientForm" style="display:none;margin-top:1rem;padding:1rem;border:1px solid var(--border);border-radius:8px;">
                        <div class="form-grid">
                            <div class="form-group">
                                <label class="form-label required">Client Name</label>
                                <input type="text" class="form-input" id="newClientName" required>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Email</label>
                                <input type="email" class="form-input" id="newClientEmail">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Phone</label>
                                <input type="tel" class="form-input" id="newClientPhone">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Notes</label>
                                <input type="text" class="form-input" id="newClientNotes">
                            </div>
                        </div>
                        <div style="display:flex;gap:0.5rem;margin-top:1rem;">
                            <button class="btn btn-primary" onclick="saveNewClient()" style="font-size:0.9rem;padding:0.5rem 1rem;">Save Client</button>
                            <button class="btn btn-secondary" onclick="document.getElementById('addClientForm').style.display='none'" style="font-size:0.9rem;padding:0.5rem 1rem;">Cancel</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Admin Link -->
            <div id="adminSection" style="display:none;text-align:center;margin-bottom:2rem;">
                <a href="admin.html" class="btn btn-primary" style="gap:0.5rem;">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="3"></circle><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1-2.83 2.83l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-4 0v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83-2.83l.06-.06A1.65 1.65 0 0 0 4.68 15a1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1 0-4h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 2.83-2.83l.06.06A1.65 1.65 0 0 0 9 4.68a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 4 0v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 2.83l-.06.06A1.65 1.65 0 0 0 19.4 9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 0 4h-.09a1.65 1.65 0 0 0-1.51 1z"></path></svg>
                    Admin Dashboard
                </a>
            </div>
        </div>
    </div>

    <!-- Footer -->
    <footer class="footer">
        <div class="home-container">
            <p class="brand-footer">&copy; 2025 Will & LPA Generator. All rights reserved.</p>
            <p>Professional legal document preparation service</p>
        </div>
    </footer>

    <script>
        // ========================================
        // Home Page Auth Logic
        // ========================================

        document.addEventListener('DOMContentLoaded', async () => {
            const session = await checkAuthSession();

            if (session) {
                // Check trial expiry
                if (currentProfile && currentProfile.subscription_status === 'trial') {
                    if (currentProfile.trial_ends_at && new Date(currentProfile.trial_ends_at) < new Date()) {
                        // Trial expired — auto-downgrade
                        const sb = getAuthSupabase();
                        if (sb) {
                            await sb.from('user_profiles').update({ subscription_status: 'inactive' }).eq('id', currentUser.id);
                            currentProfile.subscription_status = 'inactive';
                        }
                    }
                }

                // Check if user is inactive/cancelled — show pending screen
                if (currentProfile && (currentProfile.subscription_status === 'inactive' || currentProfile.subscription_status === 'cancelled')) {
                    showPending();
                } else {
                    showApp();
                }
            } else {
                showAuth();
            }
        });

        function showAuth() {
            document.getElementById('authSection').style.display = 'block';
            document.getElementById('appSection').style.display = 'none';
            document.getElementById('pendingSection').style.display = 'none';
            document.getElementById('mainNav').style.display = 'none';
        }

        function showPending() {
            document.getElementById('authSection').style.display = 'none';
            document.getElementById('appSection').style.display = 'none';
            document.getElementById('pendingSection').style.display = 'block';
            document.getElementById('mainNav').style.display = 'none';
        }

        function showApp() {
            document.getElementById('authSection').style.display = 'none';
            document.getElementById('pendingSection').style.display = 'none';
            document.getElementById('appSection').style.display = 'block';
            document.getElementById('mainNav').style.display = 'flex';

            // Welcome message
            const welcomeEl = document.getElementById('welcomeMessage');
            if (currentProfile && currentProfile.full_name) {
                welcomeEl.textContent = `Welcome, ${currentProfile.full_name}`;
            }

            // Render user header
            renderUserHeaderHome();

            // Plan-based tool visibility
            const userPlan = getCurrentUserPlan();
            const userRole = currentProfile ? currentProfile.role : 'client';
            const isAdmin = userRole === 'admin';

            // Card ID → which plans can see it
            const cardPlanMap = {
                'card-islamic-will': ['islamic', 'all'],
                'card-islamic-lpa':  ['islamic', 'all'],
                'card-standard-will': ['standard', 'all'],
                'card-standard-lpa':  ['standard', 'all']
            };

            // Nav link ID → which plans can see it
            const navPlanMap = {
                'nav-islamic-will': ['islamic', 'all'],
                'nav-islamic-lpa':  ['islamic', 'all'],
                'nav-standard-will': ['standard', 'all'],
                'nav-standard-lpa':  ['standard', 'all']
            };

            // Show/hide tool cards based on plan (admins see all)
            Object.keys(cardPlanMap).forEach(function(cardId) {
                const el = document.getElementById(cardId);
                if (el) {
                    el.style.display = (isAdmin || cardPlanMap[cardId].includes(userPlan)) ? '' : 'none';
                }
            });

            // Show/hide nav links based on plan (admins see all)
            Object.keys(navPlanMap).forEach(function(navId) {
                const el = document.getElementById(navId);
                if (el) {
                    el.style.display = (isAdmin || navPlanMap[navId].includes(userPlan)) ? '' : 'none';
                }
            });

            // Show trial banner with days remaining
            if (currentProfile && currentProfile.subscription_status === 'trial' && currentProfile.trial_ends_at) {
                const now = new Date();
                const trialEnd = new Date(currentProfile.trial_ends_at);
                const msLeft = trialEnd - now;
                const daysLeft = Math.ceil(msLeft / (1000 * 60 * 60 * 24));

                if (daysLeft > 0) {
                    document.getElementById('trialBanner').style.display = 'block';
                    document.getElementById('trialMessage').textContent =
                        daysLeft === 1
                            ? 'Your trial expires tomorrow. Contact us to continue access.'
                            : 'You have ' + daysLeft + ' days remaining on your free trial.';
                    document.getElementById('trialBadge').textContent = daysLeft + ' day' + (daysLeft !== 1 ? 's' : '') + ' left';
                }
            }

            // Show role-specific sections
            if (currentProfile) {
                if (currentProfile.role === 'solicitor') {
                    document.getElementById('solicitorSection').style.display = 'block';
                    loadClients();
                }
                if (currentProfile.role === 'admin') {
                    document.getElementById('adminSection').style.display = 'block';
                }
            }
        }

        function renderUserHeaderHome() {
            const area = document.getElementById('userHeaderArea');
            if (!area || !currentUser) return;

            const name = (currentProfile && currentProfile.full_name) || currentUser.email;
            const roleBadge = currentProfile ? (currentProfile.role === 'admin' ? ' (Admin)' :
                              currentProfile.role === 'solicitor' ? ' (Solicitor)' : '') : '';

            area.innerHTML = `
                <div style="display:flex;align-items:center;gap:0.75rem;">
                    <span style="color:rgba(255,255,255,0.9);font-size:0.85rem;font-weight:500;">
                        ${name}${roleBadge}
                    </span>
                    <button onclick="handleLogout()" style="background:rgba(255,255,255,0.15);border:1px solid rgba(255,255,255,0.3);color:white;padding:0.35rem 0.75rem;border-radius:6px;font-size:0.8rem;cursor:pointer;font-family:inherit;transition:all 0.2s;">
                        Logout
                    </button>
                </div>
            `;
        }

        // ========================================
        // Auth Tab Switching
        // ========================================

        function switchAuthTab(tab) {
            const tabs = document.querySelectorAll('.auth-tab');
            tabs.forEach(t => t.classList.remove('active'));

            if (tab === 'login') {
                tabs[0].classList.add('active');
                document.getElementById('loginForm').style.display = 'block';
                document.getElementById('signupForm').style.display = 'none';
            } else {
                tabs[1].classList.add('active');
                document.getElementById('loginForm').style.display = 'none';
                document.getElementById('signupForm').style.display = 'block';
            }

            // Clear errors
            document.getElementById('loginError').style.display = 'none';
            document.getElementById('signupError').style.display = 'none';
            document.getElementById('signupSuccess').style.display = 'none';
        }

        // ========================================
        // Login Handler
        // ========================================

        async function handleLogin(e) {
            e.preventDefault();
            const btn = document.getElementById('loginBtn');
            const errorEl = document.getElementById('loginError');
            errorEl.style.display = 'none';

            const email = document.getElementById('loginEmail').value.trim();
            const password = document.getElementById('loginPassword').value;

            btn.disabled = true;
            btn.innerHTML = '<span>Logging in...</span>';

            const { error } = await authSignIn(email, password);

            if (error) {
                errorEl.textContent = error.message;
                errorEl.style.display = 'block';
                btn.disabled = false;
                btn.innerHTML = '<span>Login</span>';
                return;
            }

            // Check trial expiry on login
            if (currentProfile && currentProfile.subscription_status === 'trial') {
                if (currentProfile.trial_ends_at && new Date(currentProfile.trial_ends_at) < new Date()) {
                    const sb = getAuthSupabase();
                    if (sb) {
                        await sb.from('user_profiles').update({ subscription_status: 'inactive' }).eq('id', currentUser.id);
                        currentProfile.subscription_status = 'inactive';
                    }
                }
            }

            // Check if user is inactive/cancelled — show pending screen
            if (currentProfile && (currentProfile.subscription_status === 'inactive' || currentProfile.subscription_status === 'cancelled')) {
                showPending();
                return;
            }

            showApp();
        }

        // ========================================
        // Signup Handler
        // ========================================

        async function handleSignup(e) {
            e.preventDefault();
            const btn = document.getElementById('signupBtn');
            const errorEl = document.getElementById('signupError');
            const successEl = document.getElementById('signupSuccess');
            errorEl.style.display = 'none';
            successEl.style.display = 'none';

            const fullName = document.getElementById('signupName').value.trim();
            const email = document.getElementById('signupEmail').value.trim();
            const password = document.getElementById('signupPassword').value;
            const role = document.getElementById('signupRole').value;

            if (!fullName) {
                errorEl.textContent = 'Please enter your full name.';
                errorEl.style.display = 'block';
                return;
            }

            btn.disabled = true;
            btn.innerHTML = '<span>Creating account...</span>';

            const { data, error } = await authSignUp(fullName, email, password, role);

            if (error) {
                errorEl.textContent = error.message;
                errorEl.style.display = 'block';
                btn.disabled = false;
                btn.innerHTML = '<span>Create Account</span>';
                return;
            }

            // Check if email confirmation is required
            if (data.user && !data.session) {
                successEl.textContent = 'Account created! Please check your email to confirm your account. An administrator will then activate your account.';
                successEl.style.display = 'block';
                btn.disabled = false;
                btn.innerHTML = '<span>Create Account</span>';
            } else {
                // Auto-logged in — but new users are inactive, show pending
                showPending();
            }
        }

        // ========================================
        // Solicitor: Client Management
        // ========================================

        async function loadClients() {
            const sb = getAuthSupabase();
            if (!sb || !currentUser) return;

            const { data, error } = await sb
                .from('solicitor_clients')
                .select('*')
                .eq('solicitor_id', currentUser.id)
                .order('created_at', { ascending: false });

            const container = document.getElementById('clientsList');
            if (!data || data.length === 0) {
                container.innerHTML = '<p style="color:var(--text-light);font-size:0.9rem;">No clients added yet.</p>';
                return;
            }

            container.innerHTML = data.map(c => `
                <div class="saved-will-card">
                    <div class="saved-will-info">
                        <h4>${c.client_name}</h4>
                        <p>${[c.client_email, c.client_phone].filter(Boolean).join(' | ') || 'No contact info'}</p>
                        ${c.notes ? `<p style="font-style:italic;">${c.notes}</p>` : ''}
                    </div>
                    <div class="saved-will-actions">
                        <button class="btn btn-secondary" onclick="deleteClient('${c.id}')" style="padding:0.4rem 0.75rem;font-size:0.8rem;color:var(--error);border-color:var(--error);">Remove</button>
                    </div>
                </div>
            `).join('');
        }

        function showAddClientForm() {
            document.getElementById('addClientForm').style.display = 'block';
        }

        async function saveNewClient() {
            const sb = getAuthSupabase();
            if (!sb || !currentUser) return;

            const name = document.getElementById('newClientName').value.trim();
            if (!name) { alert('Client name is required'); return; }

            const { error } = await sb.from('solicitor_clients').insert({
                solicitor_id: currentUser.id,
                client_name: name,
                client_email: document.getElementById('newClientEmail').value.trim(),
                client_phone: document.getElementById('newClientPhone').value.trim(),
                notes: document.getElementById('newClientNotes').value.trim()
            });

            if (error) {
                alert('Error saving client: ' + error.message);
                return;
            }

            document.getElementById('addClientForm').style.display = 'none';
            document.getElementById('newClientName').value = '';
            document.getElementById('newClientEmail').value = '';
            document.getElementById('newClientPhone').value = '';
            document.getElementById('newClientNotes').value = '';
            loadClients();
        }

        async function deleteClient(id) {
            if (!confirm('Remove this client?')) return;
            const sb = getAuthSupabase();
            if (!sb) return;

            await sb.from('solicitor_clients').delete().eq('id', id);
            loadClients();
        }
    </script>
</body>
</html>
